{% extends "base.html" %}

{% block title %}Optimization Results - Crypto Backtester{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-line text-primary"></i> Optimization Results
            </h1>
            <p class="text-muted">Task ID: <code id="taskId">{{ task_id }}</code></p>
        </div>
    </div>

    <!-- Status Card -->
    <div class="row mb-4" id="statusSection">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading optimization status...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Results (hidden initially) -->
    <div id="resultsSection" style="display: none;">
        <!-- Best Configuration -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-trophy"></i> Best Configuration
                    </div>
                    <div class="card-body" id="bestParams">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-chart-bar"></i> Performance Metrics
                    </div>
                    <div class="card-body" id="bestMetrics">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 10 Trials -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list-ol"></i> Top 10 Trials
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="trialsTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Score</th>
                                        <th>Winning Trades</th>
                                        <th>Win Rate</th>
                                        <th>Total Return</th>
                                        <th>Profit Factor</th>
                                        <th>Parameters</th>
                                    </tr>
                                </thead>
                                <tbody id="trialsTableBody">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="saveConfigBtn">
                        <i class="fas fa-save"></i> Save Best Config
                    </button>
                    <button class="btn btn-secondary" id="downloadJsonBtn">
                        <i class="fas fa-download"></i> Download JSON
                    </button>
                    <a href="/optimize" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> New Optimization
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const taskId = '{{ task_id }}';
let optimizationData = null;

async function loadResults() {
    try {
        const response = await fetch(`/api/optimize/status/${taskId}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to load results');
        }

        // Update status
        const statusSection = document.getElementById('statusSection');

        if (data.status === 'pending') {
            statusSection.innerHTML = `
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                            <h4>Pending</h4>
                            <p>Optimization is in queue. Position: ${data.queue_position || 'Unknown'}</p>
                        </div>
                    </div>
                </div>
            `;
        } else if (data.status === 'running') {
            statusSection.innerHTML = `
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h4>Running</h4>
                            <p>Optimization in progress... Progress: ${data.progress || 0}%</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     style="width: ${data.progress || 0}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (data.status === 'completed') {
            statusSection.style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            optimizationData = data.results || data;
            displayResults(optimizationData);
        } else if (data.status === 'failed') {
            statusSection.innerHTML = `
                <div class="col-md-12">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <h4>Failed</h4>
                            <p>${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Auto-refresh if not completed
        if (data.status === 'pending' || data.status === 'running') {
            setTimeout(loadResults, 5000);
        }

    } catch (err) {
        console.error('Error loading results:', err);
        document.getElementById('statusSection').innerHTML = `
            <div class="col-md-12">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h4>Error</h4>
                        <p>${err.message}</p>
                    </div>
                </div>
            </div>
        `;
    }
}

function displayResults(data) {
    // Best Parameters
    const bestParams = data.best_params || {};
    let paramsHtml = '<table class="table table-sm">';
    for (const [key, value] of Object.entries(bestParams)) {
        paramsHtml += `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
    }
    paramsHtml += '</table>';
    document.getElementById('bestParams').innerHTML = paramsHtml;

    // Best Metrics
    const bestResults = data.best_results || {};
    const basicStats = bestResults.basic_stats || {};
    const advancedMetrics = bestResults.advanced_metrics || {};

    const metricsHtml = `
        <table class="table table-sm">
            <tr><td><strong>Winning Trades</strong></td><td class="text-success">${basicStats.winning_trades || 0}</td></tr>
            <tr><td><strong>Total Trades</strong></td><td>${basicStats.total_trades || 0}</td></tr>
            <tr><td><strong>Win Rate</strong></td><td>${(basicStats.win_rate || 0).toFixed(1)}%</td></tr>
            <tr><td><strong>Total Return</strong></td><td class="${basicStats.total_return > 0 ? 'text-success' : 'text-danger'}">${(basicStats.total_return || 0).toFixed(2)}%</td></tr>
            <tr><td><strong>Profit Factor</strong></td><td>${(advancedMetrics.profit_factor || 0).toFixed(2)}</td></tr>
            <tr><td><strong>Sharpe Ratio</strong></td><td>${(advancedMetrics.sharpe_ratio || 0).toFixed(2)}</td></tr>
            <tr><td><strong>Max Drawdown</strong></td><td class="text-danger">${(advancedMetrics.max_drawdown_percent || 0).toFixed(2)}%</td></tr>
            <tr><td><strong>Best Score</strong></td><td class="text-primary"><strong>${(data.best_score || 0).toFixed(2)}</strong></td></tr>
        </table>
    `;
    document.getElementById('bestMetrics').innerHTML = metricsHtml;

    // Top Trials
    const trials = data.all_trials || [];
    let tableHtml = '';

    trials.slice(0, 10).forEach((trial, index) => {
        const results = trial.results || {};
        const stats = results.basic_stats || {};
        const metrics = results.advanced_metrics || {};

        tableHtml += `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${(trial.score || 0).toFixed(2)}</strong></td>
                <td>${stats.winning_trades || 0}</td>
                <td>${(stats.win_rate || 0).toFixed(1)}%</td>
                <td class="${stats.total_return > 0 ? 'text-success' : 'text-danger'}">${(stats.total_return || 0).toFixed(2)}%</td>
                <td>${(metrics.profit_factor || 0).toFixed(2)}</td>
                <td><small>${JSON.stringify(trial.params).substring(0, 50)}...</small></td>
            </tr>
        `;
    });

    document.getElementById('trialsTableBody').innerHTML = tableHtml || '<tr><td colspan="7" class="text-center">No trials found</td></tr>';
}

// Save config button
document.getElementById('saveConfigBtn').addEventListener('click', async () => {
    const userId = prompt('Enter your Telegram User ID:');
    if (!userId) return;

    const btn = document.getElementById('saveConfigBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    try {
        const response = await fetch(`/api/optimize/save-config/${taskId}`, {
            method: 'POST',
            headers: {
                'X-User-ID': userId
            }
        });

        const result = await response.json();

        if (response.ok) {
            alert(`✅ ${result.message}`);
        } else {
            alert(`❌ Error: ${result.error}`);
        }
    } catch (err) {
        alert(`❌ Error: ${err.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Save Best Config';
    }
});

// Download JSON button
document.getElementById('downloadJsonBtn').addEventListener('click', () => {
    if (!optimizationData) {
        alert('No data to download');
        return;
    }

    const dataStr = JSON.stringify(optimizationData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `optimization_${taskId}.json`;
    a.click();
    URL.revokeObjectURL(url);
});

// Initial load
loadResults();
</script>
{% endblock %}
