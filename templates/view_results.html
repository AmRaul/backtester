{% extends "base.html" %}

{% block title %}Результаты бэктеста {{ task_id[:8] }} - Crypto Backtester{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <!-- Заголовок -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Результаты бэктеста
                    </h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">ID: {{ task_id[:8] }}...</span>
                        <a href="{{ url_for('results_page') }}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Назад к списку
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Основные метрики -->
<div class="row">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">
                    {{ "%.2f"|format(results.basic_stats.total_return if results.basic_stats else 0) }}%
                </h5>
                <p class="card-text small">Общая доходность</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">
                    {{ results.basic_stats.win_rate if results.basic_stats else 0 }}%
                </h5>
                <p class="card-text small">Винрейт</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    {{ results.basic_stats.total_trades if results.basic_stats else 0 }}
                </h5>
                <p class="card-text small">Всего сделок</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    {{ "%.2f"|format(results.basic_stats.max_drawdown if results.basic_stats else 0) }}%
                </h5>
                <p class="card-text small">Макс. просадка</p>
            </div>
        </div>
    </div>
</div>

<!-- Графики -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Графики
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if charts.equity_curve %}
                    <div class="col-md-6 mb-4">
                        <h6>Кривая эквити</h6>
                        <img src="data:image/png;base64,{{ charts.equity_curve }}" class="img-fluid" alt="Кривая эквити">
                    </div>
                    {% endif %}
                    
                    {% if charts.pnl_distribution %}
                    <div class="col-md-6 mb-4">
                        <h6>Распределение PnL</h6>
                        <img src="data:image/png;base64,{{ charts.pnl_distribution }}" class="img-fluid" alt="Распределение PnL">
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Детальная статистика -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Основные метрики
                </h6>
            </div>
            <div class="card-body">
                {% if results.basic_stats %}
                <table class="table table-sm">
                    <tr>
                        <td>Начальный баланс:</td>
                        <td class="text-end">${{ "%.2f"|format(results.basic_stats.initial_balance) }}</td>
                    </tr>
                    <tr>
                        <td>Финальный баланс:</td>
                        <td class="text-end">${{ "%.2f"|format(results.basic_stats.current_balance) }}</td>
                    </tr>
                    <tr>
                        <td>Общая прибыль:</td>
                        <td class="text-end">${{ "%.2f"|format(results.basic_stats.total_profit) }}</td>
                    </tr>
                    <tr>
                        <td>Средняя прибыль:</td>
                        <td class="text-end">${{ "%.2f"|format(results.basic_stats.avg_profit) }}</td>
                    </tr>
                    <tr>
                        <td>Средний убыток:</td>
                        <td class="text-end">${{ "%.2f"|format(results.basic_stats.avg_loss) }}</td>
                    </tr>
                    <tr>
                        <td>Profit Factor:</td>
                        <td class="text-end">{{ "%.2f"|format(results.basic_stats.profit_factor) }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Риск-метрики
                </h6>
            </div>
            <div class="card-body">
                {% if results.risk_metrics %}
                <table class="table table-sm">
                    <tr>
                        <td>Sharpe Ratio:</td>
                        <td class="text-end">{{ "%.2f"|format(results.risk_metrics.sharpe_ratio) }}</td>
                    </tr>
                    <tr>
                        <td>Sortino Ratio:</td>
                        <td class="text-end">{{ "%.2f"|format(results.risk_metrics.sortino_ratio) }}</td>
                    </tr>
                    <tr>
                        <td>Calmar Ratio:</td>
                        <td class="text-end">{{ "%.2f"|format(results.risk_metrics.calmar_ratio) }}</td>
                    </tr>
                    <tr>
                        <td>Recovery Factor:</td>
                        <td class="text-end">{{ "%.2f"|format(results.risk_metrics.recovery_factor) }}</td>
                    </tr>
                    <tr>
                        <td>VaR (95%):</td>
                        <td class="text-end">{{ "%.2f"|format(results.risk_metrics.var_95) }}%</td>
                    </tr>
                    <tr>
                        <td>Max Consecutive Losses:</td>
                        <td class="text-end">{{ results.risk_metrics.max_consecutive_losses }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- История сделок -->
{% if results.trade_history %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    История сделок
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Тип</th>
                                <th>Цена входа</th>
                                <th>Цена выхода</th>
                                <th>Объем</th>
                                <th>PnL</th>
                                <th>PnL %</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in results.trade_history[:20] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    {% if trade.type == 'long' %}
                                        <span class="badge bg-success">Long</span>
                                    {% else %}
                                        <span class="badge bg-danger">Short</span>
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(trade.entry_price) }}</td>
                                <td>${{ "%.2f"|format(trade.exit_price) }}</td>
                                <td>{{ "%.4f"|format(trade.volume) }}</td>
                                <td class="{% if trade.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "%.2f"|format(trade.pnl) }}
                                </td>
                                <td class="{% if trade.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.2f"|format(trade.pnl_percent) }}%
                                </td>
                                <td>
                                    <small>{{ trade.entry_time.strftime('%d.%m %H:%M') if trade.entry_time else '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if results.trade_history|length > 20 %}
                <div class="text-center mt-3">
                    <small class="text-muted">Показаны первые 20 сделок из {{ results.trade_history|length }}</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Действия -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>
                    Экспорт результатов
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="downloadReport()">
                            <i class="fas fa-file-pdf me-2"></i>PDF отчет
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="downloadCsv()">
                            <i class="fas fa-file-csv me-2"></i>CSV сделки
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" onclick="downloadJson()">
                            <i class="fas fa-file-code me-2"></i>JSON данные
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" onclick="shareResults()">
                            <i class="fas fa-share me-2"></i>Поделиться
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Скачивание отчета
async function downloadReport() {
    try {
        showNotification('Генерация PDF отчета...', 'info');
        
        const response = await fetch(`/api/generate-report/{{ task_id }}`);
        const result = await response.json();
        
        if (result.success) {
            showNotification('PDF отчет готов!', 'success');
            // В реальном приложении здесь был бы редирект на скачивание
        } else {
            showNotification(`Ошибка: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Ошибка: ${error.message}`, 'error');
    }
}

// Скачивание CSV
function downloadCsv() {
    showNotification('Функция скачивания CSV в разработке', 'info');
}

// Скачивание JSON
function downloadJson() {
    showNotification('Функция скачивания JSON в разработке', 'info');
}

// Поделиться результатами
function shareResults() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: 'Результаты бэктеста',
            text: 'Посмотрите результаты моего бэктеста',
            url: url
        });
    } else {
        // Fallback - копирование в буфер обмена
        navigator.clipboard.writeText(url).then(() => {
            showNotification('Ссылка скопирована в буфер обмена', 'success');
        });
    }
}

// Показ уведомлений
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
{% endblock %}
