{% extends "base.html" %}

{% block title %}Результаты бэктестов - Crypto Backtester{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Результаты бэктестирования
                    </h4>
                </div>
            <div class="card-body">
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID задачи</th>
                                <th>Символ</th>
                                <th>Направление</th>
                                <th>Доходность</th>
                                <th>Период</th>
                                <th>Статус</th>
                                <th>Время запуска</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>
                                    <code class="small">{{ task.task_id[:8] }}...</code>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ task.config_symbol }}</span>
                                </td>
                                <td>
                                    {% if task.order_type == 'long' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-arrow-up me-1"></i>Long
                                        </span>
                                    {% elif task.order_type == 'short' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-arrow-down me-1"></i>Short
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.total_return is not none %}
                                        {% if task.total_return >= 0 %}
                                            <span class="text-success fw-bold">+{{ "%.2f"|format(task.total_return) }}%</span>
                                        {% else %}
                                            <span class="text-danger fw-bold">{{ "%.2f"|format(task.total_return) }}%</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if task.start_date and task.end_date %}
                                            {{ task.start_date[:10] }} - {{ task.end_date[:10] }}
                                        {% elif task.start_date %}
                                            с {{ task.start_date[:10] }}
                                        {% elif task.end_date %}
                                            до {{ task.end_date[:10] }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% if task.status == 'completed' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Завершен
                                        </span>
                                    {% elif task.status == 'error' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>Ошибка
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>{{ task.status }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if task.start_time %}
                                            {% if task.start_time is string %}
                                                {{ task.start_time }}
                                            {% else %}
                                                {{ task.start_time.strftime('%d.%m.%Y %H:%M') }}
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% if task.status == 'completed' %}
                                        <a href="{{ url_for('view_results', task_id=task.task_id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Просмотр
                                        </a>
                                        <button class="btn btn-sm btn-outline-success" onclick="downloadReport('{{ task.task_id }}')">
                                            <i class="fas fa-download me-1"></i>Отчет
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBacktest('{{ task.task_id }}')">
                                            <i class="fas fa-trash me-1"></i>Удалить
                                        </button>
                                    {% elif task.status == 'error' %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="showError('{{ task.task_id }}')">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Ошибка
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBacktest('{{ task.task_id }}')">
                                            <i class="fas fa-trash me-1"></i>Удалить
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-info" onclick="checkStatus('{{ task.task_id }}')">
                                            <i class="fas fa-sync me-1"></i>Обновить
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Нет результатов бэктестирования</h5>
                    <p class="text-muted">Запустите первый бэктест, чтобы увидеть результаты здесь</p>
                    <a href="{{ url_for('config_page') }}" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Начать бэктест
                    </a>
                </div>
                {% endif %}
            </div>
            </div>
        </div>
    </div>

    <!-- Статистика (если есть результаты) -->
    {% if tasks %}
    <div class="row mt-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-primary mb-2">{{ tasks|length }}</div>
                    <p class="mb-0 text-muted">Всего бэктестов</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-success mb-2">
                        {{ tasks|selectattr('status', 'equalto', 'completed')|list|length }}
                    </div>
                    <p class="mb-0 text-muted">Завершено</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-danger mb-2">
                        {{ tasks|selectattr('status', 'equalto', 'error')|list|length }}
                    </div>
                    <p class="mb-0 text-muted">Ошибок</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-warning mb-2">
                        {{ tasks|rejectattr('status', 'in', ['completed', 'error'])|list|length }}
                    </div>
                    <p class="mb-0 text-muted">В процессе</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Быстрые действия -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2 text-primary"></i>
                        Быстрые действия
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('config_page') }}" class="btn btn-primary w-100">
                                <i class="fas fa-plus me-2"></i>Новый бэктест
                            </a>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-info w-100" onclick="refreshResults()">
                                <i class="fas fa-sync me-2"></i>Обновить список
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100" onclick="clearOldResults()">
                                <i class="fas fa-trash me-2"></i>Очистить старые
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для ошибок -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ошибка выполнения
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="errorMessage" class="alert alert-danger">
                    <!-- Сообщение об ошибке будет вставлено сюда -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для статуса -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Статус задачи
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statusMessage">
                    <!-- Статус будет вставлен сюда -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Показ ошибки
function showError(taskId) {
    // В реальном приложении здесь был бы запрос к API для получения деталей ошибки
    document.getElementById('errorMessage').innerHTML = `
        <strong>Задача:</strong> ${taskId}<br>
        <strong>Ошибка:</strong> Детали ошибки недоступны в демо-режиме
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
}

// Проверка статуса
async function checkStatus(taskId) {
    try {
        const response = await fetch(`/api/backtest-status/${taskId}`);
        const status = await response.json();
        
        let statusHtml = `
            <div class="alert alert-info">
                <strong>Статус:</strong> ${status.status}<br>
                <strong>Прогресс:</strong> ${status.progress || 0}%
            `;
        
        if (status.results_summary) {
            statusHtml += `
                <br><strong>Результаты:</strong><br>
                • Сделок: ${status.results_summary.total_trades || 0}<br>
                • Винрейт: ${(status.results_summary.win_rate || 0).toFixed(1)}%<br>
                • Доходность: ${(status.results_summary.total_return || 0).toFixed(2)}%
            `;
        }
        
        statusHtml += `</div>`;
        
        document.getElementById('statusMessage').innerHTML = statusHtml;
        
        const modal = new bootstrap.Modal(document.getElementById('statusModal'));
        modal.show();
        
        // Если задача завершена, обновляем страницу
        if (status.status === 'completed') {
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    } catch (error) {
        showNotification(`Ошибка получения статуса: ${error.message}`, 'error');
    }
}

// Скачивание отчета
async function downloadReport(taskId) {
    try {
        showNotification('Генерация отчета...', 'info');
        
        const response = await fetch(`/api/generate-report/${taskId}`);
        const result = await response.json();
        
        if (result.success) {
            showNotification('Отчет сгенерирован!', 'success');
            // В реальном приложении здесь был бы редирект на скачивание файла
        } else {
            showNotification(`Ошибка: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Ошибка: ${error.message}`, 'error');
    }
}

// Обновление результатов
function refreshResults() {
    window.location.reload();
}

// Удаление конкретного бэктеста
async function deleteBacktest(taskId) {
    if (!confirm('Вы уверены, что хотите удалить этот бэктест?')) {
        return;
    }

    try {
        const response = await fetch(`/api/backtest/${taskId}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
            showNotification('Бэктест успешно удален', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(`Ошибка: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Ошибка удаления: ${error.message}`, 'error');
    }
}

// Очистка старых результатов
async function clearOldResults() {
    if (!confirm('Удалить все завершенные бэктесты?')) {
        return;
    }

    try {
        const response = await fetch('/api/backtest/clear-all', {
            method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
            showNotification(`Удалено ${result.deleted_count} бэктестов`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(`Ошибка: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Ошибка очистки: ${error.message}`, 'error');
    }
}

// Показ уведомлений
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Автообновление каждые 30 секунд для активных задач
setInterval(() => {
    const activeTasks = document.querySelectorAll('tr:has(.badge.bg-warning)');
    if (activeTasks.length > 0) {
        // В реальном приложении здесь был бы запрос к API для обновления статусов
        console.log('Проверка активных задач...');
    }
}, 30000);
</script>
{% endblock %}
