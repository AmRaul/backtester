{% extends "base.html" %}

{% block title %}–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –±—ç–∫—Ç–µ—Å—Ç–∞{% endblock %}

{% block content %}
<!-- –ó–∞–≥—Ä—É–∂–∞–µ–º Plotly —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ -->
<script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>

<!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="container-fluid mb-2">
    <div class="alert alert-info" id="debug-info" style="font-family: monospace; font-size: 12px;">
        <strong>üîç –û—Ç–ª–∞–¥–∫–∞:</strong> <span id="debug-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-chart-line me-2"></i>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h2>
            <p class="text-muted">Task ID: {{ task_id }}</p>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group" aria-label="–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞">
                <button type="button" class="btn btn-primary active" data-chart-type="all">
                    <i class="fas fa-th me-1"></i>–í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
                </button>
                <button type="button" class="btn btn-outline-primary" data-chart-type="price">
                    <i class="fas fa-candlestick me-1"></i>–¶–µ–Ω–∞ –∏ —Å–¥–µ–ª–∫–∏
                </button>
                <button type="button" class="btn btn-outline-primary" data-chart-type="balance">
                    <i class="fas fa-dollar-sign me-1"></i>–ë–∞–ª–∞–Ω—Å
                </button>
                <button type="button" class="btn btn-outline-primary" data-chart-type="pnl">
                    <i class="fas fa-chart-bar me-1"></i>PnL
                </button>
                <button type="button" class="btn btn-outline-primary" data-chart-type="drawdown">
                    <i class="fas fa-chart-area me-1"></i>–ü—Ä–æ—Å–∞–¥–∫–∞
                </button>
                <button type="button" class="btn btn-outline-primary" data-chart-type="distribution">
                    <i class="fas fa-chart-pie me-1"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
                </button>
            </div>
            <button type="button" class="btn btn-outline-secondary ms-3" onclick="window.location.href='/results/{{ task_id }}'">
                <i class="fas fa-arrow-left me-1"></i>–ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            </button>

            <!-- –ß–µ–∫–±–æ–∫—Å—ã –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
            <div class="ms-3 d-inline-block">
                <div class="form-check form-switch d-inline-block me-3">
                    <input class="form-check-input" type="checkbox" id="showEmaCheck">
                    <label class="form-check-label" for="showEmaCheck">
                        <i class="fas fa-chart-line me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å EMA (50, 200)
                    </label>
                </div>
                <div class="form-check form-switch d-inline-block">
                    <input class="form-check-input" type="checkbox" id="showRsiCheck">
                    <label class="form-check-label" for="showRsiCheck">
                        <i class="fas fa-tachometer-alt me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å RSI
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="row mb-4" id="loading-indicator" style="display: none;">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞...</p>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body p-0">
                    <div id="plotly-chart-container">
                        <!-- –ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å—é–¥–∞ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>–°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—ã—à—å –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ –≥—Ä–∞—Ñ–∏–∫—É.
                –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ç–æ—á–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
            </div>
        </div>
    </div>
</div>

<style>
    .btn-group .btn {
        transition: all 0.3s ease;
    }

    #plotly-chart-container {
        min-height: 800px;
        height: auto;  /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è subplot */
        background: #ffffff;
    }

    #plotly-chart {
        width: 100%;
        height: 100%;
    }

    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<script>
    const taskId = '{{ task_id }}';
    let currentChartType = 'all';

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function updateDebug(text) {
        const debugEl = document.getElementById('debug-text');
        if (debugEl) {
            debugEl.innerHTML = text;
        }
        console.log('[Debug]', text);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ Plotly
    function waitForPlotly(callback, maxAttempts = 50) {
        let attempts = 0;
        updateDebug('–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ Plotly...');

        const checkInterval = setInterval(() => {
            attempts++;
            if (typeof Plotly !== 'undefined') {
                clearInterval(checkInterval);
                console.log('[Visualization] Plotly –∑–∞–≥—Ä—É–∂–µ–Ω!');
                updateDebug('‚úÖ Plotly –∑–∞–≥—Ä—É–∂–µ–Ω! –í–µ—Ä—Å–∏—è: ' + Plotly.version);
                callback();
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                console.error('[Visualization] Plotly –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ—Å–ª–µ', maxAttempts, '–ø–æ–ø—ã—Ç–æ–∫');
                updateDebug('‚ùå Plotly –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Plotly. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            }
        }, 100);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[Visualization] DOM –∑–∞–≥—Ä—É–∂–µ–Ω');

        // –ñ–¥–µ–º –ø–æ–∫–∞ Plotly –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        waitForPlotly(function() {
            loadVisualization('all');
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        document.querySelectorAll('[data-chart-type]').forEach(button => {
            button.addEventListener('click', function() {
                const chartType = this.dataset.chartType;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                document.querySelectorAll('[data-chart-type]').forEach(btn => {
                    btn.classList.remove('btn-primary', 'active');
                    btn.classList.add('btn-outline-primary');
                });
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary', 'active');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                loadVisualization(chartType);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
        document.getElementById('showEmaCheck').addEventListener('change', function() {
            loadVisualization(currentChartType);
        });

        document.getElementById('showRsiCheck').addEventListener('change', function() {
            loadVisualization(currentChartType);
        });
    });

    function loadVisualization(chartType) {
        currentChartType = chartType;

        console.log('[Visualization] –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞:', chartType);
        updateDebug('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞: ' + chartType);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('plotly-chart-container').innerHTML = '';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
        const showEma = document.getElementById('showEmaCheck').checked;
        const showRsi = document.getElementById('showRsiCheck').checked;

        const url = `/api/visualization/${taskId}?type=${chartType}&show_ema=${showEma}&show_rsi=${showRsi}`;
        console.log('[Visualization] URL:', url);
        updateDebug('üåê –ó–∞–ø—Ä–æ—Å –∫ API...');

        // –ó–∞–ø—Ä–æ—Å –∫ API
        fetch(url)
            .then(response => {
                console.log('[Visualization] Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[Visualization] –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', {
                    success: data.success,
                    chart_type: data.chart_type,
                    has_graph: !!data.graph_json
                });

                updateDebug('üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞...');

                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loading-indicator').style.display = 'none';

                if (data.success && data.graph_json) {
                    try {
                        // –ü–∞—Ä—Å–∏–º JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –≥—Ä–∞—Ñ–∏–∫–∞
                        const graphData = JSON.parse(data.graph_json);
                        console.log('[Visualization] –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω, traces:', graphData.data.length);
                        updateDebug('üîß –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö: ' + graphData.data.length + ' traces');

                        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Å–æ–∑–¥–∞–µ–º div –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                        const container = document.getElementById('plotly-chart-container');
                        container.innerHTML = '<div id="plotly-chart" style="width:100%;height:100%;"></div>';

                        updateDebug('üé® –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...');

                        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑—É—è Plotly (—Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –∫–∞–∫ –≤ TradingView)
                        Plotly.newPlot('plotly-chart', graphData.data, graphData.layout, {
                            responsive: true,
                            displayModeBar: true,
                            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                            displaylogo: false,
                            scrollZoom: true,  // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
                            doubleClick: 'reset'  // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ –∑—É–º–∞
                        }).then(() => {
                            console.log('[Visualization] ‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                            updateDebug('‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ! –ú–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
                        }).catch(err => {
                            console.error('[Visualization] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏:', err);
                            updateDebug('‚ùå –û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏: ' + err.message);
                            showError('–û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + err.message);
                        });

                    } catch (err) {
                        console.error('[Visualization] ‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', err);
                        updateDebug('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + err.message);
                        showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞: ' + err.message);
                    }
                } else {
                    updateDebug('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'));
                    showError(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏');
                }
            })
            .catch(error => {
                console.error('[Visualization] –û—à–∏–±–∫–∞:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message);
            });
    }

    function showError(message) {
        document.getElementById('plotly-chart-container').innerHTML = `
            <div class="alert alert-danger m-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>–û—à–∏–±–∫–∞:</strong> ${message}
            </div>
        `;
    }
</script>
{% endblock %}
